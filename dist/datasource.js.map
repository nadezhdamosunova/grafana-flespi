{"version":3,"sources":["../src/datasource.js"],"names":["_","FlespiDatasource","instanceSettings","$q","backendSrv","templateSrv","type","jsonData","undefined","url","uri","headers","token","name","q","options","console","log","JSON","stringify","query","buildQueryParameters","targets","filter","t","hide","length","target","parameter","when","data","svc_name","parameters","replace","from","parseInt","Date","parse","range","to","interval_sec","scopedVars","__interval_ms","value","request_params","max_count","maxDataPoints","fields","left_key","right_key","gen_interval","generalize","doRequest","method","then","response","result","dict","i","params","param","datapoints","push","key","status","message","title","annotation","annotationQuery","datasource","enable","iconColor","rangeRaw","res","label","split","text","indexOf","j","withCredentials","datasourceRequest","map","refId"],"mappings":"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","file":"datasource.js","sourcesContent":["import _ from \"lodash\";\n\nexport class FlespiDatasource {\n\nconstructor(instanceSettings, $q, backendSrv, templateSrv) {\n    this.type = instanceSettings.type;\n    if (instanceSettings.jsonData != undefined) {\n        this.url = instanceSettings.jsonData.uri;\n        this.headers = {'Authorization': 'FlespiToken ' + instanceSettings.jsonData.token};\n    } else {\n        this.url = \"\";\n        this.headers = {};\n    }\n    this.name = instanceSettings.name;\n    this.q = $q;\n    this.backendSrv = backendSrv;\n    this.templateSrv = templateSrv;\n}\n\n// -----------------------------------\n// query metrics values and convert into timeseries\n// -----------------------------------\nquery(options) {\n    console.log(\"before: \" + JSON.stringify(options))\n    var query = this.buildQueryParameters(options)\n    console.log(\"in the middle: \" + JSON.stringify(query))\n    query.targets = query.targets.filter(t => !t.hide)\n    console.log(\"after: \" + JSON.stringify(query))\n\n    if (query.targets == null || query.targets.length <= 0 || !query.targets[0].target || !query.targets[0].parameter) {\n        // unknown target - return empty result - no data points\n        return this.q.when({data: []});\n    }\n    // prepare params for request\n    var svc_name = query.targets[0].target\n    var parameters = query.targets[0].parameter.replace(/[{})]/g, '')\n    var from = parseInt(Date.parse(query.range.from) / 1000)\n    var to = parseInt(Date.parse(query.range.to) / 1000)\n    var interval_sec = query.scopedVars.__interval_ms.value / 1000\n\n    var request_params = {max_count: query.maxDataPoints, fields: parameters, left_key: from, right_key : to}\n    if (interval_sec !== 0 && query.maxDataPoints > 0 && ((to - from)/interval_sec > query.maxDataPoints)) {\n        // generalize parameters\n        var gen_interval = (to - from)/query.maxDataPoints\n        request_params.generalize = gen_interval >= 60 ? parseInt(gen_interval) : 60\n    }\n\n    return this.doRequest({\n        url: this.url + '/containers/name=' + svc_name + '|*/messages?data=' + JSON.stringify(request_params),\n        method: 'GET'\n    }).then(response => {\n        // parse response: convert container messages to timeseries\n        var data = [];\n        if (!response.data.result || response.data.result.length == 0) {\n            // empty response - no data points\n            return {data: data};\n        }\n\n        var dict = {}\n        for (var i = 0; i < response.data.result.length; i++) {\n            // for each item in `result` array, i.e. each container message\n            var params = response.data.result[i].params;\n            for (var param in params) {\n                if (!dict[param]) {\n                    dict[param] = {\n                        datapoints: []\n                    }\n                }\n                dict[param].datapoints.push([params[param], parseInt(response.data.result[i].key * 1000)]);\n            }\n        }\n        // format parameters dictionary to timeseries\n        for (var param in dict) {\n            console.log(\"target: \" + param + \", datapoints length: \" + dict[param].datapoints.length)\n            data.push({\n                target: param,\n                datapoints: dict[param].datapoints\n            });\n        }\n        return {data: data};\n    });\n}\n// -----------------------------------\n// check connection to datasource\n// -----------------------------------\ntestDatasource() {\n    return this.doRequest({\n        url: this.url + '/containers/all',\n        method: 'GET',\n    }).then(response => {\n        if (response.status === 200) {\n            return { status: \"success\", message: \"Data source is working\", title: \"Success\" };\n        }\n    });\n}\n// -----------------------------------\n// query annotations from the datasource\n// -----------------------------------\nannotationQuery(options) {\n    var query = this.templateSrv.replace(options.annotation.query, {}, 'glob');\n    var annotationQuery = {\n        range: options.range,\n        annotation: {\n            name: options.annotation.name,\n            datasource: options.annotation.datasource,\n            enable: options.annotation.enable,\n            iconColor: options.annotation.iconColor,\n            query: query\n        },\n        rangeRaw: options.rangeRaw\n    };\n\n    return this.doRequest({\n        url: this.url + '/annotations',\n        method: 'POST',\n        data: annotationQuery\n    }).then(result => {\n        return result.data;\n    });\n}\n\n// -----------------------------------\n// query possible metrics for the datasource\n// -----------------------------------\nmetricFindQuery(query) {\n    query = this.templateSrv.replace(query, null, 'glob')\n    console.log(query)\n// --- fetch all services\n    if (query == \"services.*\") {\n        return this.doRequest({\n            url: this.url + '/containers/all',\n            method: 'GET',\n        }).then(response => {\n            const res = [];\n            const data = response.data.result;\n            for (var i = 0; i < data.length; i++) {\n                var label;\n                if (data[i].name == undefined || data[i].name == null) {\n                    continue\n                } else {\n                    var svc_name = data[i].name.split('|')\n                    label = svc_name[0];\n                }\n                res.push({value: label, text: label})\n            }\n            return res;\n        });\n    }\n// --- fetch parameters for services\n    if (query.indexOf(\".params.*\") !== -1) {\n        var svc_name = query.split('.')[0]\n        console.log(\"++++++++++++ \" + svc_name)\n        return this.doRequest({\n            url: this.url + '/containers/name=' + svc_name + '*?fields=parameters',\n            method: 'GET',\n        }).then(response => {\n            const res = [];\n            const data = response.data.result;\n\n            for (let i = 0; i < data.length; i++) {\n                var parameters = data[i].parameters;\n                for (let j = 0; j < parameters.length; j++) {\n                    res.push({value: parameters[j], text: parameters[j]});\n                }\n            }\n            return res;\n        });\n    }\n// --- unknown metric query\n    return this.doRequest({\n           url: this.url + '/containers/all',\n           method: 'GET',\n    }).then(metrics => {\n        return { status: \"success\", message: \"Only `services` and `params` queries are supported\", title: \"Choose query\" };\n    });\n  }\n\n// -----------------------------------\n// helper functions\n// -----------------------------------\ndoRequest(options) {\n    options.withCredentials = this.withCredentials;\n    options.headers = this.headers;\n\n    return this.backendSrv.datasourceRequest(options);\n}\n\nbuildQueryParameters(options) {\n    //remove placeholder targets\n    options.targets = _.filter(options.targets, target => {\n        return target.target !== 'select metric';\n    });\n\n    options.targets = _.filter(options.targets, target => {\n        return target.parameter !== 'select parameter';\n    });\n\n    var targets = _.map(options.targets, target => {\n        return {\n            target: this.templateSrv.replace(target.target, options.scopedVars, 'regex'),\n            refId: target.refId,\n            hide: target.hide,\n            parameter: this.templateSrv.replace(target.parameter, options.scopedVars, 'glob')\n        };\n    });\n    options.targets = targets;\n    return options;\n}\n\n}\n"]}