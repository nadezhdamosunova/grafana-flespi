{"version":3,"sources":["../src/datasource.js"],"names":["_","FlespiDatasource","instanceSettings","$q","backendSrv","templateSrv","type","jsonData","undefined","url","uri","headers","token","name","q","options","console","log","JSON","stringify","query","buildQueryParameters","targets","filter","t","hide","length","target","parameter","when","data","svc_name","parameters","replace","from","parseInt","Date","parse","range","to","interval_sec","scopedVars","__interval_ms","value","request_params","max_count","maxDataPoints","fields","left_key","right_key","generalize","doRequest","method","then","response","result","dict","i","params","param","datapoints","push","key","status","message","title","annotation","annotationQuery","datasource","enable","iconColor","rangeRaw","res","label","split","text","indexOf","j","withCredentials","datasourceRequest","map","refId"],"mappings":"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","file":"datasource.js","sourcesContent":["import _ from \"lodash\";\n\nexport class FlespiDatasource {\n\nconstructor(instanceSettings, $q, backendSrv, templateSrv) {\n    this.type = instanceSettings.type;\n    if (instanceSettings.jsonData != undefined) {\n        this.url = instanceSettings.jsonData.uri;\n        this.headers = {'Authorization': 'FlespiToken ' + instanceSettings.jsonData.token};\n    } else {\n        this.url = \"\";\n        this.headers = {};\n    }\n    this.name = instanceSettings.name;\n    this.q = $q;\n    this.backendSrv = backendSrv;\n    this.templateSrv = templateSrv;\n}\n\n// -----------------------------------\n// query metrics values and convert into timeseries\n// -----------------------------------\nquery(options) {\n    console.log(\"before: \" + JSON.stringify(options))\n    var query = this.buildQueryParameters(options);\n    console.log(\"in the middle: \" + JSON.stringify(query))\n    query.targets = query.targets.filter(t => !t.hide);\n    console.log(\"after: \" + JSON.stringify(query))\n\n    if (query.targets == null || query.targets.length <= 0 || !query.targets[0].target || !query.targets[0].parameter) {\n        // unknown target - return empty result - no data points\n        return this.q.when({data: []});\n    }\n    // prepare params for request\n    var svc_name = query.targets[0].target;\n    var parameters = query.targets[0].parameter.replace(/[{})]/g, '');\n    var from = parseInt(Date.parse(query.range.from) / 1000);\n    var to = parseInt(Date.parse(query.range.to) / 1000);\n    var interval_sec = query.scopedVars.__interval_ms.value / 1000;\n\n    var request_params = {max_count: query.maxDataPoints, fields: parameters, left_key: from, right_key : to}\n    if (interval_sec >= 60) {\n        request_params.generalize = interval_sec;\n    }\n\n    return this.doRequest({\n        url: this.url + '/containers/name=' + svc_name + '|*/messages?data=' + JSON.stringify(request_params),\n        method: 'GET'\n    }).then(response => {\n        // parse response: convert container messages to timeseries\n        var data = [];\n        if (!response.data.result || response.data.result.length == 0) {\n            // empty response - no data points\n            return {data: data};\n        }\n\n        var dict = {}\n        for (var i = 0; i < response.data.result.length; i++) {\n            // for each item in `result` array, i.e. each container message\n            var params = response.data.result[i].params;\n            for (var param in params) {\n                if (!dict[param]) {\n                    dict[param] = {\n                        datapoints: []\n                    }\n                }\n                dict[param].datapoints.push([params[param], parseInt(response.data.result[i].key * 1000)]);\n            }\n        }\n        // format parameters dictionary to timeseries\n        for (var param in dict) {\n            data.push({\n                target: param,\n                datapoints: dict[param].datapoints\n            });\n        }\n        return {data: data};\n    });\n}\n// -----------------------------------\n// check connection to datasource\n// -----------------------------------\ntestDatasource() {\n    return this.doRequest({\n        url: this.url + '/containers/all',\n        method: 'GET',\n    }).then(response => {\n        if (response.status === 200) {\n            return { status: \"success\", message: \"Data source is working\", title: \"Success\" };\n        }\n    });\n}\n// -----------------------------------\n// query annotations from the datasource\n// -----------------------------------\nannotationQuery(options) {\n    var query = this.templateSrv.replace(options.annotation.query, {}, 'glob');\n    var annotationQuery = {\n        range: options.range,\n        annotation: {\n            name: options.annotation.name,\n            datasource: options.annotation.datasource,\n            enable: options.annotation.enable,\n            iconColor: options.annotation.iconColor,\n            query: query\n        },\n        rangeRaw: options.rangeRaw\n    };\n\n    return this.doRequest({\n        url: this.url + '/annotations',\n        method: 'POST',\n        data: annotationQuery\n    }).then(result => {\n        return result.data;\n    });\n}\n\n// -----------------------------------\n// query possible metrics for the datasource\n// -----------------------------------\nmetricFindQuery(query) {\n    query = this.templateSrv.replace(query, null, 'glob')\n    console.log(query)\n// --- fetch all services\n    if (query == \"services.*\") {\n        return this.doRequest({\n            url: this.url + '/containers/all',\n            method: 'GET',\n        }).then(response => {\n            const res = [];\n            const data = response.data.result;\n            for (var i = 0; i < data.length; i++) {\n                var label;\n                if (data[i].name == undefined || data[i].name == null) {\n                    continue\n                } else {\n                    var svc_name = data[i].name.split('|')\n                    label = svc_name[0];\n                }\n                res.push({value: label, text: label})\n            }\n            return res;\n        });\n    }\n// --- fetch parameters for services\n    if (query.indexOf(\".params.*\") !== -1) {\n        var svc_name = query.split('.')[0]\n        console.log(\"++++++++++++ \" + svc_name)\n        return this.doRequest({\n            url: this.url + '/containers/name=' + svc_name + '*?fields=parameters',\n            method: 'GET',\n        }).then(response => {\n            const res = [];\n            const data = response.data.result;\n\n            for (let i = 0; i < data.length; i++) {\n                var parameters = data[i].parameters;\n                for (let j = 0; j < parameters.length; j++) {\n                    res.push({value: parameters[j], text: parameters[j]});\n                }\n            }\n            return res;\n        });\n    }\n// --- unknown metric query\n    return this.doRequest({\n           url: this.url + '/containers/all',\n           method: 'GET',\n    }).then(metrics => {\n        return { status: \"success\", message: \"Only `services` and `params` queries are supported\", title: \"Choose query\" };\n    });\n  }\n\n// -----------------------------------\n// helper functions\n// -----------------------------------\ndoRequest(options) {\n    options.withCredentials = this.withCredentials;\n    options.headers = this.headers;\n\n    return this.backendSrv.datasourceRequest(options);\n}\n\nbuildQueryParameters(options) {\n    //remove placeholder targets\n    options.targets = _.filter(options.targets, target => {\n        return target.target !== 'select metric';\n    });\n\n    options.targets = _.filter(options.targets, target => {\n        return target.parameter !== 'select parameter';\n    });\n\n    var targets = _.map(options.targets, target => {\n        return {\n            target: this.templateSrv.replace(target.target, options.scopedVars, 'regex'),\n            refId: target.refId,\n            hide: target.hide,\n            parameter: this.templateSrv.replace(target.parameter, options.scopedVars, 'glob')\n        };\n    });\n    options.targets = targets;\n    return options;\n}\n\n}\n"]}